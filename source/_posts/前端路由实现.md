---
title: 前端路由实现
date: 2020-04-26 15:55:55
tags:
---

路由的概念来源于服务端，在服务端中路由描述的是URL与处理函数之间的映射关系。
在Web前端单页应用中，路由描述的是URL与UI之间的映射关系，这种映射是单向的，即URL变化引起UI更新（**无需刷新页面**）

## 实现前端路由的基本原理
要实现前端路由，需要解决两个核心问题
1.改变URL不引起页面刷新
2.检测URL变化

利用hash或history可以解决这两个问题
### hash实现
1.hash是URL中hash (#)及后面的那部分，常用作锚点在页面内进行导航，改变URL中的hash部分不会引起页面刷新
2.通过hashchange事件监听URL的变化。
浏览器前进或后退改变URL、通过标签改变URL、通过window.location改变URL，这几种情况都会触发hashchange事件

```html
<body>
  <ul>
    <!-- 定义路由 -->
    <li><a href="#/home">home</a></li>
    <li><a href="#/about">about</a></li>

    <!-- 渲染路由对应的 UI -->
    <div id="routeView"></div>
  </ul>
</body>
<script>
    // 页面加载完不会触发 hashchange，这里主动触发一次 hashchange 事件
    window.addEventListener('DOMContentLoaded', onLoad)
    // 监听路由变化
    window.addEventListener('hashchange', onHashChange)

    // 路由视图
    var routerView = null

    function onLoad () {
    routerView = document.querySelector('#routeView')
    onHashChange()
    }
</script>
```

### history实现
1.history提供了pushState和replaceState两个方法，这两个方法改变URL的path部分不会引起页面刷新
2.history提供popstate事件。但通过通过pushState/replaceState或标签改变 URL 不会触发 popstate 事件。但可以拦截pushState/replaceState的调用和标签的点击事件来检测 URL 变化，所以监听 URL 变化可以实现。

```html
<body>
  <ul>
    <li><a href='/home'>home</a></li>
    <li><a href='/about'>about</a></li>

    <div id="routeView"></div>
  </ul>
</body>
<script>
    // 页面加载完不会触发 hashchange，这里主动触发一次 hashchange 事件
window.addEventListener('DOMContentLoaded', onLoad)
// 监听路由变化
window.addEventListener('popstate', onPopState)

// 路由视图
var routerView = null

function onLoad () {
  routerView = document.querySelector('#routeView')
  onPopState()

 href="">  // 拦截 <a> 标签点击事件默认行为， 点击时使用 pushState 修改 URL并更新手动 UI，从而实现点击链接更新 URL 和 UI 的效果。
  var linkList = document.querySelectorAll('a[href]')
  linkList.forEach(el => el.addEventListener('click', function (e) {
    e.preventDefault()
    history.pushState(null, '', el.getAttribute('href'))
    onPopState()
  }))
}

// 路由变化时，根据路由渲染对应 UI
function onPopState () {
  switch (location.pathname) {
    case '/home':
      routerView.innerHTML = 'Home'
      return
    case '/about':
      routerView.innerHTML = 'About'
      return
    default:
      return
  }
}
</script>
```