---
title: 浏览器原理
date: 2020-05-13 22:30:27
tags: 前端
---

## 浏览器的多进程架构

以chorme浏览器为例，其主要进程及其职责如下：
Browser Process:
1.负责包括地址栏，书签栏，前进后退按钮等部分的工作；
2.负责处理浏览器的一些不可见的底层操作，比如网络请求和文件访问。

Renderer Process
负责一个tab（标签页）内关于网页呈现的所有事情

Plugin Process负责控制一个网页用到的所以有插件，如flash

GPU Process
负责处理GPU相关的任务

在不同硬件上，根据硬件性能产生不同的进程（提供不同服务，例如UI进程），当硬件资源贫瘠时，部分服务会合并到一个进程中（上述提到的几个进程是比较基本的）。

## Browser Process
浏览器tab（标签）外的工作主要由Browser Process掌握，Browser Process又对这些工作进行划分，由不同线程进行处理。

1.UI thread: 控制浏览器上的按钮及输入框
2.newwork thread：处理网络请求，从网上获取数据
3.storage thread：控制文件等的访问

## Render Process

渲染进程几乎负责Tab内的所有事情，渲染进程的核心目的在于转换HTML CSS JS为用户可交互的web页面。渲染进程中主要包含以下线程：
1.主线程（Main thread）
2.工作线程（Worker thread）
3.排版线程 （Compositior therad）
4.光栅线程 （Raster thread）

### 渲染流程
#### 构建DOOM（生成DOM树）
当渲染进程接收到导航的确认信息，开始接受HTML数据时，主线程会解析文本字符串为DOM
渲染html为DOM的方法由HTML Standard定义

#### 加载次级的资源
网页中常常包含诸如图片，CSS，JS等额外的资源，这些资源需要从网络上或者cache中获取。主进程可以在构建DOM过程中逐一请求它们，为了加速preload scanner会同时运行，如果html中存在img，link等标签，preload scanner会把这些请求传递给Browser process中的network thread进行相关资源的下载。

#### JS的下载与执行
当遇到script标签时，渲染进程会停止解析HTML，而去加载解析和执行JS代码，停止解析html的愿意在于JS可能会改变DOM结构。

通过给script标签添加async（异步加载，加载完成直接运行且无序），defer（异步加载，解析完成后执行，有序）

#### 样式计算（生成样式树）
仅渲染DOM还不足以获知页面的具体样式，主进程还会基于CSS选择器解析CSS获取每一个节点的最终的计算样式值，即使不提供任何CSS，浏览器对每个元素也会有一个默认的样式。

#### 获取布局
想要渲染一个完整的页面，除了获知每个节点的具体样式，还需要获知每一个节点在页面上的位置，布局其实是找到所有元素的几何关系的过程。
通过遍历DOM级相关元素的计算样式，主线程会构建出包含每个元素的坐标信息即盒子大小的布局树（Layout tree）。布局树和DOM树类似，但是其中只包含页面可见的元素，如果一个元素设置了‘display:none',这个元素不会出现在布局树上，伪元素虽然在DOM树上不可见，但是在布局树上是可见的。

#### 绘制各元素

即使知道了不同元素的位置及样式信息，我们还需要知道不同元素的绘制先后顺序才能正确绘制出整个页面。在绘制阶段，主线程会遍历布局树以创建绘制记录。绘制记录可以看做是记录各元素绘制先后顺序的笔记。

#### 合成帧

熟悉 PS 等绘图软件的童鞋肯定对图层这一概念不陌生，现代 Chrome 其实利用了这一概念来组合不同的层。

复合是一种分割页面为不同的层，并单独栅格化，随后组合为帧的技术。不同层的组合由 compositor 线程（合成器线程）完成。

主线程会遍历布局树来创建层树（layer tree），添加了 'will-change' CSS 属性的元素，会被看做单独的一层，